---
layout: post
title:  "Making an RC Roobma"
date:   2022-11-26 14:49:38 -0600
categories: Maker
---

So all of this started when I filed my first patent. This blog has nothing to _do_ with said patent, beyond it being ultimately part of a version 4 prototype, but this ridulous thing wouldn't exist without the patent. 

What is it? How did I do it? How many things did I fry in the process of making it? (Hint: far too many). These and all your other questions will be answered after the break.

----

<iframe width="720" height="480" src="https://www.youtube.com/embed/Bek-pxtkyso" frameborder="0" allowfullscreen></iframe>
---


Feel free to award internet points as appropriate.

üëèüëèüëèüëèüëèüëè
{: .iota}

So first of all yes this isn't a roomba, but that's what this little fellow is _trying_ to be. It may also be better to say this started at a yard sale when I picked up this little vacuum for $20. I had no clue Hoover made robot vacuums and had a hope that Hoover wouldn't put too much work into them. This turned out to be a mid range model that had a suprising number of features and not great reviews. 

After snatching the little thing up it sat around for a few months until I decided exactly what I wanted to do with it. I ultimately ended up on making it the new platform for a room exploration prototype that's been in the works for a few years (and will eventually get its own blog post). Before going through the effort of taking the existing prototype apart, designing new platforms for everything to sit on and integrating it into this vacuum I wanted to kick the tires, and what better way to get a feel for the components than to get it working with an old Playstation controller so I can drive it around, vacuum some stuff up and try to improve its (currently) fairly sad performance. 

The first step to do all of this though was a good ol' fashioned 

## Teardown and part cataloging

Let's start with a nice before picture and then we'll get to the innards
![hoover_top](/assets/images/hoover_top.png)

And after a reasonable straightforward top removal we ended up with this:
![hoover_no_top](/assets/images/hoover_no_top.png)

The above photo leaves out the collector for dirt/dust/debris, the vacuum motor and a few bump sensors. Each sensor connects to the main board with a easy to remove plug and there weren't any gotchas during disassembly. 

I am in no way an expert at tearing things apart successfully, but I would give Hoover a ifixit (sometimes ibreakit) score of 9/10. Everything is included in a way that makes sense and there isn't anything that can't be taking out in a way that doesn't let you put it back in again. 

The brains of our little vacuum friend are a STM32F101, providing a pretty beefy chip for what it can do out of the box. 
![close up of stm32](/assets/images/stm_closeup.png)

For a bit I did go down the road of trying to read from the chip and possibly reprogram it with my own code (which would be _very_ nice since the board would give me connections to everything right away) but ultimately decided not too because:  
1) I couldn't get anything that made sense out of any of the open pins on the board 
2) I don't know enough about hardware to say for certain there wasn't some kind of protection in place for the chip and
3) This wasn't the particular rabbit hole I wanted to go down that day. 

I gave up and decided to replace the board with something else to drive everything, but since this vacuum is so easy to reassemble I set it aside to maybe come back and figure it out later. 


Contiuing on with the tear down! There are a lot of gooides in this little vacuum that would be easy to repurpose without too much trouble. Keeping in mind that the code would have to be reimplemented to get everything working it has nice components with plugs that include: 
- Motors with hall effects sensors 
![battery picture](/assets/images/motor_hall_effect.png)
- IR distance sensors 
- Bump sensors
- 2 12V motors 
- A 12V 2000mAh battery
![battery picture](/assets/images/hoover_battery.png)

Just having all of this would be worth the $20 I paid for it already, but every component has clip on connectors that make hooking them up to something else a _breeze_. 

With the teardown completed, the parts catalouged and the screws (mostly) stored somewhere safe it was time to 

## Figure out how this stuff works
I decided to spend most of my time focusing on how to get the motors working, since getting each motor to run on command would get the vacuum doing it's job of, uh... vacuuming. 

I couldn't find anything online to help me figure out how the motors worked beyond knowing they were normal DC motors (except the vacuum motor, which I'll get to in a bit). The two primary wheel motors each have a six pin connector with two powering the motor and the rest for the hall effect sensor. I used a multimeter to test the board as it was running and saw the voltage sat at around 5v consistently, and that _should_ be enough to trigger the motors so testing consisted of running 5V to each pin and seeing what turned the motor. I found the ground pin marked on the board attached to the motor, so it was just a matter of testing each pin to see when the motor responded. 

For this I used my trusty DIY bench top power supply. It's ain't pretty, but it works great for what I need.

![battery picture](/assets/images/hey_it_does_a_good_job.png)

Running 5V to two wires and testing each pin on the motor cable showed me the first two were what I needed. Pin 1 is ground, pin 2 is motor positive voltage. These were 12V motors, so I was able to run them up to 12 volts with no issues (and no smoke).

This method worked for getting the brush motors to work as well, just with less pins and no known ground. I tested this one with around 3V (since I didn't know what the ground pin was) and very quick voltage tests, and still no smoke so everything worked out in the end. 

The final motor to figure out was the vacuum motor, and this one proved to be a bit tricket. 


![picture of vacuum motor](/assets/images/vacuum_motor.png)

I was able to find some information based on the model, but testing each wire with the same method used for the other motors didn't produce any results. I had recently taken apart a cordless stick vacuum and saw it's vacuum motor was actually brushless, so I thought this could be the same situation. This motor wasn't easily taken apart, and I really didn't want to break it since vacuuming, is the _main_ feature of a... vacuum. 

Thankfully I had some RC equipment that I could use to test the motor. Brushless motors are three phase, which means the motor needs three wires with pulses sent at a set frequency to get it to spin. I grabbed an electronic speed controller (ESC), powered it up and started testing. 

![vacuum motor test](/assets/images/vacuum_motor_test.png)
After running through each pin and every combination of wires (the three wires in a brushless motor aren't order dependent, so there weren't too many to try out) nothing was spinng and no noises. I decided to peel up the stickers on the motor and found a LB11867F motor controller! I of course knew exactly what this motor was an realized I needed to ground a pin to let the motor run at full speed*.

---
\* This is no way reflects what actually happened which included a lot of googling, trying to translate Chinese datasheets and guessing that I could replace a potiometer with a ground to get the motor spinning.

---

With all the motors spinning, directions figured out and lots of reference photos taken I was ready to move on to hooking it all up. 

## Ahead there be smoke...

To drive all of the motors I wanted to reuse the platform for my previous prototype, a Raspberry Pi Zero W with an Adafruit Motor Controller. For the kind of work I was doing I could definetly use something with less power, but I didn't want to redo work that was already done. 

I also had code already written that would connect to a PS4 controller with bluetooth and use the joysticks to drive two directional motors on a tracked vehicle, so why redo that work. The final wiring proved to be fairly simple, with each of the four motors hooked up to a block on the motor controller, the power from the batteries going into the power on the controller and a buck converter stepping down the voltage to run the Pi. 

![vacuum motor test](/assets/images/three_motor_test.png)

A quick test confirmed all of the motors worked, but I didn't have time to reassemble and test the full vacuum. Things got busy and it sat around for a few weeks before I got back to it, and at some point the wires came loose. When I redid the wiring I was in a rush, and didn't notice the wires to the buck converter were backwards, so when I plugged it in there was a _lot_ of smoke. 

After investigating the damage _not only did I fry a Pi Zero but also the motor controller_. This came at a time when Pi's are incredibly hard to find, and especially Pi zeros. Luckily I had a backup I could grab from another project, and even more fortuantly I found one about a month later using the wonderful [Pi Locator](https://rpilocator.com/). 

I ended up taking out the buck converter (also fried) and just using a small USB power bank to run the Pi. The buck converter will get added back in later, but maybe a model with more protections built in. 

Finally everything was ready. The code was [done](https://github.com/lmatte7/hoover_rc/blob/main/run.py), the batteries charged and the top back on. It was time to get to work! The only problem was the batteries that came with the vacuum weren't up to the job. It was unable to go a few feet with the vacuum on before slowing down to a crawl. There are lots of reasons this could have happened, but I decided to take call it a battery problem and fix it with a swap. 

After swapping in a 14v LiPo battery for racing drones the vacuum ran _great_. It had better movement, suction and lasted longer. There was even enough room in the front of the vacuum that the motor controller stayed nice and cool throughout a whole house vacuum. 

Overall this was a fun time (fried boards aside) and I learned a lot about a few different subjects. There's still work to do for some of the sensors (I really want to get the hall effect sensors on the motors working) but for now my RC roomba works great. Just for parts alone I would happily pick another one of these up at a yard sale and I may need to find another cheap robo vacuum to compare the differences. 